<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <title>AutoKeeper | <%= user.username || user.displayName %>'s Maintenance History</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://kit.fontawesome.com/a45ab2c295.js" crossorigin="anonymous"></script>
</head>
<body>
    <%- include('partials/navbar/') %>
    <% if (user) { %>
        <h1 class="mx-auto mt-5 mb-3 text-center">Welcome, <span class="special"><%= user.displayName || user.username %><span></h1>
    <% } %>
    <% services.sort((a, b) => b.date - a.date) %>
    <!-- TODO: Insert summary section with last service date, mileage, and summary of service performed -->
    <div class="container-fluid my-3 mx-auto" style="width:75%;">
        <div class="row gx-2 justify-content-between">
            <div class="col-md-6">
                <div class="card h-100 p-3">
                    <% if(vehicles.length > 0) { %>
                        <div class="card-body">
                            <% vehicles.forEach(vehicle => { %>
                                <h3><%= vehicle.name %></h3> <br>
                                <h5><%= vehicle.year %> <%= vehicle.make %> <%= vehicle.model %></h5> <br>
                                <h5><%= vehicle.otherInfo %></h5> <br>
                                <a href="/editVehicle/<%=vehicle._id%>" class="text-primary text-decoration-none text-black small"><i class="fa-solid fa-pen special"></i> Update Vehicle Info</a>
                            <% }) %>
                            </div>   
                    <% } else { %>
                        <p class="text-center mt-5">No vehicle currently saved.</p>
                        <a href="/vehicle" class="btn btn-custom text mx-auto"><i class="fa-solid fa-plus"></i> Add Vehicle Info</a>
                    <% } %>
                </div>
            </div>
            <div class="col-md-6 d-flex flex-column justify-content-between">
                <!-- This div also takes up 50% width -->
                <!-- First card -->
                <div class="card mb-2 p-2">
                    <div class="card-body">
                        <p>Mileage Last Serviced:</p>
                        <h2><i class="fa-solid fa-gauge"></i></i><%= services[0].mileage %></h2>
                        <!-- TODO: Take most recent service mileage and input here -->
                        <!-- TODO: Add theming icon -->
                    </div>
                </div>
                <!-- Second card -->
                <div class="card">
                    <div class="card-body">
                        <p>Date Last Serviced:</p>
                        <h2 class="stat stat-ltr"><i class="fa-regular fa-calendar-days"></i><%= services[0].date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %></h2>
                            <!-- TODO: Add theming icon -->
                        <p>Summary: <%= services[0].typeOfService %></p>
                            
                    </div>
                </div>
            </div>
        </div>
    </div>

        <h5 class="mx-auto text-center mt-5 mb-3">Previous service logs for  <%= vehicles[0].year %> <%= vehicles[0].make %> <%= vehicles[0].model %>:</h5>

<div class="container">
    <% let index = 1; %>  
    <% services.forEach(service => { %>
    <div class="accordion mx-auto">
        <div class="accordion-item">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="true" aria-controls="collapse<%= index %>">
                <h5 class="accordion-header">
                    Service <%= service.date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
                </h5>
            </button>
            <div id="collapse<%= index %>" class="accordion-collapse collapse hide" data-bs-parent="#accordionExample">
                <div class="accordion-body d-flex">
                    <div class="text-content">
                    <p>
                        Mileage: <%= service.mileage %> <br>
                        Service Performed: <%= service.typeOfService %> <br>
                        Service Notes: <%= service.serviceNotes %> <br>
                        Posted By <%= service.user.username %> <br>
                    </p>
                    <% if (currentUser && service.user._id.equals(currentUser._id)) {%>
                        <div class="d-flex">
                            <a href="/edit/<%= service._id %>" class="btn btn-primary mx-2">Edit</a>

                            <form action="/delete/<%= service._id %>" method="POST">
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    <% index++; %>
    <% }) %>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>